package com.nsdl.ndhm.transfer.service.impl;

import com.google.gson.Gson;
import com.nsdl.ndhm.dto.RespDTO;
import com.nsdl.ndhm.dto.datareport.CareContextDtls;
import com.nsdl.ndhm.dto.datareport.ReportRequestDto;
import com.nsdl.ndhm.dto.datareport.RequestWrapper;
import com.nsdl.ndhm.repository.CareContextRepository;
import com.nsdl.ndhm.repository.HipRequestRepository;
import com.nsdl.ndhm.service.ReportService;
import com.nsdl.ndhm.transfer.dto.*;
import com.nsdl.ndhm.transfer.entity.CareContextConsentEntity;
import com.nsdl.ndhm.transfer.entity.CareContextsEntity;
import com.nsdl.ndhm.transfer.entity.HipRequestEntity;
import com.nsdl.ndhm.transfer.repository.CareContextConsentRepository;
import com.nsdl.ndhm.transfer.service.DataTranferRequestService;
import com.nsdl.ndhm.utility.CommonHeadersUtil;
import com.nsdl.ndhm.utility.fhir.encrypt.Encryption;
import com.nsdl.ndhm.utility.fhir.encrypt.EncryptionRequest;
import com.nsdl.ndhm.utility.fhir.encrypt.EncryptionResponse;
import com.nsdl.ndhm.utility.fhir.files.prescrip.Prescription;
import com.nsdl.ndhm.utility.fhir.keys.KeyMaterial;
import com.nsdl.ndhm.utility.fhir.keys.KeysGenerator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.net.URI;
import java.text.SimpleDateFormat;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.stream.Collectors;

import static com.nsdl.ndhm.utility.FhirEncryptDecryptUtil.*;

@Service
public class DataTranferRequestServiceImpl implements DataTranferRequestService {

	private static final Logger logger = LoggerFactory.getLogger(DataTranferRequestServiceImpl.class);

	@Autowired
	CareContextRepository careContextRepository;

	@Autowired
	HipRequestRepository hipRequestRepository;

	@Autowired
	CareContextConsentRepository careContextConsentRepository;

	@Autowired
	CommonHeadersUtil commonHeadersUtil;

	@Autowired
	Encryption encryption;

	@Autowired
	KeysGenerator keysGenerator;

	@Autowired
	ReportService reportService;

	@Autowired
	Prescription prescription;

	@Autowired
	private RestTemplate restTemplate;

	@Value("${ndhm.onRequest}")
	String onRequest;

	@Value("${ndhm.transfer.onNotify}")
	String transferNotify;

	private static final String DATE_FORMAT = "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'";

	private OnRequestRespDTO prepareRequestDummyData(DataRequestDTO dataRequestDTO) {
		SimpleDateFormat format1 = new SimpleDateFormat(DATE_FORMAT, Locale.US);
		format1.setTimeZone(TimeZone.getTimeZone("UTC"));
		return OnRequestRespDTO.builder().requestId(UUID.randomUUID().toString()).timestamp(format1.format(new Date()))
				.hiRequest(HiRequestRespDTo.builder().transactionId(dataRequestDTO.getTransactionId())
						.sessionStatus("ACKNOWLEDGED").build())
				.resp(RespDTO.builder().requestId(dataRequestDTO.getRequestId()).build()).build();
	}

	/*
	 * for demo request call
	 */
	@Override
	public ResponseEntity<String> requestDemo(DataRequestDTO dataRequestDTO) {
		logger.info("Request Receives for Request Starts");

		String url = onRequest;
		ResponseEntity<String> result = null;
		Map<String, List<String>> reportMap;
		URI uri;

		try {
			uri = new URI(url);
			String stringData = new Gson().toJson(prepareRequestDummyData(dataRequestDTO));
			HttpEntity<String> requestEntity = new HttpEntity<>(stringData,
					commonHeadersUtil.getHeadersWithXCmIdFromServer());

			result = restTemplate.exchange(uri, HttpMethod.POST, requestEntity, String.class);

			if (result.getStatusCode().is2xxSuccessful()) {

				String consentId = dataRequestDTO.getHiRequest().getConsent().getId();
				CareContextConsentEntity careContext = careContextConsentRepository.getByConcentId(consentId);

				RequestWrapper<?> requestWrapper = RequestWrapper.builder().request(ReportRequestDto.builder()
						.abhaId(careContext.getPatientId())
						.careContextIds(careContext.getCareContexts().stream().map(
								careContextsEntity -> new CareContextDtls(careContextsEntity.getCareContextReference()))
								.collect(Collectors.toList()))
						.build()).build();

				uri = new URI(dataRequestDTO.getHiRequest().getDataPushUrl());
				reportMap = reportService.getReportData(requestWrapper);

				if (!reportMap.isEmpty()) {

					DataTransferDTO dataTransferDTO = prepareDataNewDTO(dataRequestDTO, reportMap);
/*				    uri = new URI(dataRequestDTO.getHiRequest().getDataPushUrl());
					DataTransferDTO dataTransferDTO = dataTransferDummy(dataRequestDTO);*/
					stringData = new Gson().toJson(dataTransferDTO);
					logger.info(" transactionID {}", dataTransferDTO.getTransactionId());
/*					logger.info("encryptedString length: {}", stringData.length());*/
					requestEntity = new HttpEntity<>(stringData,
							commonHeadersUtil.getHeadersWithAccessTokenFromServer());
/*					logger.info("requestEntity {}" ,requestEntity);*/
				    logger.info("URI {}" ,uri);
					result = restTemplate.exchange(uri, HttpMethod.POST, requestEntity, String.class);

					if (result.getStatusCode().is2xxSuccessful()) {
						callNotify(dataRequestDTO, "SUCCESS");
					}
				} else {
					callNotify(dataRequestDTO, "FAILED");
				}
			}
		} catch (Exception e) {
			logger.info("Error in On-Request {} ", e);
		}
		logger.info("Request Receives for Request ends");
		return result;
	}

	private HipRequestEntity prepareHipRequestSaveData(DataRequestDTO dataRequestDTO) {
		HiRequestDTO hiRequestDTO = dataRequestDTO.getHiRequest();
		DateRangeDTO dateRangeDTO = hiRequestDTO.getDateRange();
		KeyMaterialDTO keyMaterialDTO = hiRequestDTO.getKeyMaterial();
		DhPublicKeyDTO dhPublicKeyDTO = keyMaterialDTO.getDhPublicKey();
		return HipRequestEntity.builder().requestId(dataRequestDTO.getRequestId())
				.timestamp(dataRequestDTO.getTimestamp()).transactionId(dataRequestDTO.getTransactionId())
				.consentId(hiRequestDTO.getConsent().getId()).dateRangeFrom(dateRangeDTO.getFrom())
				.dateRangeTo(dateRangeDTO.getTo()).dataPushUrl(hiRequestDTO.getDataPushUrl())
				.cryptoAlg(keyMaterialDTO.getCryptoAlg()).curve(keyMaterialDTO.getCurve())
				.dhPublicKeyExpiry(dhPublicKeyDTO.getExpiry()).dhPublicKeyParameters(dhPublicKeyDTO.getParameters())
				.keyValue(dhPublicKeyDTO.getKeyValue()).nonce(keyMaterialDTO.getNonce()).build();
	}

	private DataTransferDTO prepareDataTransferDTO(DataRequestDTO dataRequestDTO) throws Exception {
		senderPublicPrivateKeygen();
		String senderPublicKey = getSenderPublicKey();
		String randomKeySender = senderNonce();
		KeyMaterialDTO receiverKeyMaterial = dataRequestDTO.getHiRequest().getKeyMaterial();
		/*
		 * logger.info("senderPublicKey {}", senderPublicKey);
		 * logger.info("randomKeySender {}", randomKeySender);
		 * logger.info("ReceiverPublicKey {}",
		 * receiverKeyMaterial.getDhPublicKey().getKeyValue());
		 * logger.info("randomKeyReceiver {}", receiverKeyMaterial.getNonce());
		 */
		String encryptedFhir = encrypt(receiverKeyMaterial.getNonce(),
				receiverKeyMaterial.getDhPublicKey().getKeyValue());

//		logger.info("encryptedFhir {}", encryptedFhir);

		EntryDTO entryDTO = EntryDTO.builder().content(encryptedFhir).media("application/fhir+json").checksum("")
				.careContextReference("CARE_CNTX_55009").build();

		// logger.info("ReceiverKeyMaterialDTO {}", receiverKeyMaterial);

		KeyMaterialDTO keyMaterialDTO = KeyMaterialDTO.builder().cryptoAlg(receiverKeyMaterial.getCryptoAlg())
				.curve(receiverKeyMaterial.getCurve())
				.dhPublicKey(DhPublicKeyDTO.builder().expiry("2022-02-21T12:00:50.810Z")
						.parameters(receiverKeyMaterial.getDhPublicKey().getParameters()).keyValue(senderPublicKey)
						.build())
				.nonce(randomKeySender).build();

		return DataTransferDTO.builder().pageCount(1).pageNumber(1).transactionId(dataRequestDTO.getTransactionId())
				.entries(Arrays.asList(entryDTO)).keyMaterial(keyMaterialDTO).build();
	}

	private DataTransferDTO prepareDataNewDTO(DataRequestDTO dataRequestDTO, Map<String, List<String>> fhirMap)
			throws Exception {
		logger.info("prepareDataNewDTO starts");
		String expiryDate = DateTimeFormatter.ofPattern(DATE_FORMAT).format(ZonedDateTime.now().plusDays(30));

		String fhirOriginal = "{\n  \"resourceType\": \"Bundle\",\n  \"id\": \"prescription-bundle-01\",\n  \"meta\": {\n    \"versionId\": \"1\",\n    \"lastUpdated\": \"2020-07-09T15:32:26.605+05:30\",\n    \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/DocumentBundle\" ],\n    \"security\": [ {\n      \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n      \"code\": \"V\",\n      \"display\": \"very restricted\"\n    } ]\n  },\n  \"identifier\": {\n    \"system\": \"http://hip.in\",\n    \"value\": \"bc3c6c57-2053-4d0e-ac40-139ccccff645\"\n  },\n  \"type\": \"document\",\n  \"timestamp\": \"2020-07-09T15:32:26.605+05:30\",\n  \"entry\": [ {\n    \"fullUrl\": \"Composition/Composition-01\",\n    \"resource\": {\n      \"resourceType\": \"Composition\",\n      \"id\": \"Composition-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2020-07-09T15:32:26.605+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/PrescriptionRecord\" ]\n      },\n      \"language\": \"en-IN\",\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Prescription report</div>\"\n      },\n      \"identifier\": {\n        \"system\": \"https://ndhm.in/phr\",\n        \"value\": \"645bb0c3-ff7e-4123-bef5-3852a4784813\"\n      },\n      \"status\": \"final\",\n      \"type\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"440545006\",\n          \"display\": \"Prescription record\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      },\n      \"date\": \"2017-05-27T11:46:09+05:30\",\n      \"author\": [ {\n        \"reference\": \"Practitioner/Practitioner-01\"\n      } ],\n      \"title\": \"Prescription record\",\n      \"section\": [ {\n        \"title\": \"Prescription record\",\n        \"code\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"440545006\",\n            \"display\": \"Prescription record\"\n          } ]\n        },\n        \"entry\": [ {\n          \"reference\": \"MedicationRequest/MedicationRequest-01\",\n          \"type\": \"MedicationRequest\"\n        }, {\n          \"reference\": \"MedicationRequest/MedicationRequest-02\",\n          \"type\": \"MedicationRequest\"\n        }, {\n          \"reference\": \"Binary/Binary-01\",\n          \"type\": \"Binary\"\n        } ]\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Patient/Patient-01\",\n    \"resource\": {\n      \"resourceType\": \"Patient\",\n      \"id\": \"Patient-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2020-07-09T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Patient\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">ABC, 41 year, Male</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MR\",\n            \"display\": \"Medical record number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/SwasthID\",\n        \"value\": \"1234\"\n      } ],\n      \"name\": [ {\n        \"text\": \"ABC\"\n      } ],\n      \"telecom\": [ {\n        \"system\": \"phone\",\n        \"value\": \"+919818512600\",\n        \"use\": \"home\"\n      } ],\n      \"gender\": \"male\",\n      \"birthDate\": \"1981-01-12\"\n    }\n  }, {\n    \"fullUrl\": \"Practitioner/Practitioner-01\",\n    \"resource\": {\n      \"resourceType\": \"Practitioner\",\n      \"id\": \"Practitioner-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2019-05-29T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Practitioner\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Dr. DEF, MD (Medicine)</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MD\",\n            \"display\": \"Medical License number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/DigiDoc\",\n        \"value\": \"7601003178999\"\n      } ],\n      \"name\": [ {\n        \"text\": \"Dr. DEF\"\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"MedicationRequest/MedicationRequest-01\",\n    \"resource\": {\n      \"resourceType\": \"MedicationRequest\",\n      \"id\": \"MedicationRequest-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/MedicationRequest\" ]\n      },\n      \"status\": \"active\",\n      \"intent\": \"order\",\n      \"medicationCodeableConcept\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"324252006\",\n          \"display\": \"Azithromycin (as azithromycin dihydrate) 250 mg oral capsule\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\",\n        \"display\": \"ABC\"\n      },\n      \"authoredOn\": \"2020-07-09\",\n      \"requester\": {\n        \"reference\": \"Practitioner/Practitioner-01\",\n        \"display\": \"Dr DEF\"\n      },\n      \"reasonCode\": [ {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"11840006\",\n          \"display\": \"Traveller\'s Diarrhea (disorder)\"\n        } ]\n      } ],\n      \"reasonReference\": [ {\n        \"reference\": \"Condition/Condition-01\"\n      } ],\n      \"dosageInstruction\": [ {\n        \"text\": \"One tablet at once\",\n        \"additionalInstruction\": [ {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"311504000\",\n            \"display\": \"With or after food\"\n          } ]\n        } ],\n        \"timing\": {\n          \"repeat\": {\n            \"frequency\": 1,\n            \"period\": 1,\n            \"periodUnit\": \"d\"\n          }\n        },\n        \"route\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"26643006\",\n            \"display\": \"Oral Route\"\n          } ]\n        },\n        \"method\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"421521009\",\n            \"display\": \"Swallow\"\n          } ]\n        }\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"MedicationRequest/MedicationRequest-02\",\n    \"resource\": {\n      \"resourceType\": \"MedicationRequest\",\n      \"id\": \"MedicationRequest-02\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/MedicationRequest\" ]\n      },\n      \"status\": \"active\",\n      \"intent\": \"order\",\n      \"medicationCodeableConcept\": {\n        \"text\": \"Paracetemol 500mg Oral Tab\"\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\",\n        \"display\": \"ABC\"\n      },\n      \"authoredOn\": \"2020-07-09\",\n      \"requester\": {\n        \"reference\": \"Practitioner/Practitioner-01\",\n        \"display\": \"Dr DEF\"\n      },\n      \"reasonCode\": [ {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"602001\",\n          \"display\": \"Ross river fever\"\n        } ]\n      } ],\n      \"reasonReference\": [ {\n        \"reference\": \"Condition/Condition-01\"\n      } ],\n      \"dosageInstruction\": [ {\n        \"text\": \"Take two tablets orally with or after meal once a day\"\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Condition/Condition-01\",\n    \"resource\": {\n      \"resourceType\": \"Condition\",\n      \"id\": \"Condition-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Condition\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Abdominal pain on 09-July 2020</div>\"\n      },\n      \"code\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"21522001\",\n          \"display\": \"Abdominal pain\"\n        } ],\n        \"text\": \"Abdominal pain\"\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      }\n    }\n  }, {\n    \"fullUrl\": \"Binary/Binary-01\",\n    \"resource\": {\n      \"resourceType\": \"Binary\",\n      \"id\": \"Binary-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Binary\" ]\n      },\n      \"contentType\": \"application/pdf\",\n      \"data\": \"R0lGODlhfgCRAPcAAAAAAIAAAACAAICAAAAAgIAAoxrXyMY2uvGNcIyjHOeoxkXBh44OOZdn8Ggu+DiPjwtJ2CZyUomCTRGO\"\n    }\n  } ]\n}";

		String fhirNew = "{\n  \"resourceType\": \"Bundle\",\n  \"id\": \"prescription-bundle-02\",\n  \"meta\": {\n    \"versionId\": \"1\",\n    \"lastUpdated\": \"2020-07-09T15:32:26.605+05:30\",\n    \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/DocumentBundle\" ],\n    \"security\": [ {\n      \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n      \"code\": \"V\",\n      \"display\": \"very restricted\"\n    } ]\n  },\n  \"identifier\": {\n    \"system\": \"http://hip.in\",\n    \"value\": \"bc3c6c57-2053-4d0e-ac40-139ccccff645\"\n  },\n  \"type\": \"document\",\n  \"timestamp\": \"2020-07-09T15:32:26.605+05:30\",\n  \"entry\": [ {\n    \"fullUrl\": \"Composition/Composition-01\",\n    \"resource\": {\n      \"resourceType\": \"Composition\",\n      \"id\": \"Composition-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2020-07-09T15:32:26.605+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/PrescriptionRecord\" ]\n      },\n      \"language\": \"en-IN\",\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Prescription report</div>\"\n      },\n      \"identifier\": {\n        \"system\": \"https://ndhm.in/phr\",\n        \"value\": \"645bb0c3-ff7e-4123-bef5-3852a4784813\"\n      },\n      \"status\": \"final\",\n      \"type\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"440545006\",\n          \"display\": \"Prescription record\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      },\n      \"date\": \"2017-05-27T11:46:09+05:30\",\n      \"author\": [ {\n        \"reference\": \"Practitioner/Practitioner-01\"\n      } ],\n      \"title\": \"Prescription record\",\n      \"section\": [ {\n        \"title\": \"Prescription record\",\n        \"code\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"440545006\",\n            \"display\": \"Prescription record\"\n          } ]\n        },\n        \"entry\": [ \n\t\t{\n          \"reference\": \"Binary/Binary-01\",\n          \"type\": \"Binary\"\n        } ]\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Patient/Patient-01\",\n    \"resource\": {\n      \"resourceType\": \"Patient\",\n      \"id\": \"Patient-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2020-07-09T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Patient\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">ABC, 41 year, Male</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MR\",\n            \"display\": \"Medical record number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/SwasthID\",\n        \"value\": \"1234\"\n      } ],\n      \"name\": [ {\n        \"text\": \"ABC\"\n      } ],\n      \"telecom\": [ {\n        \"system\": \"phone\",\n        \"value\": \"+919818512600\",\n        \"use\": \"home\"\n      } ],\n      \"gender\": \"male\",\n      \"birthDate\": \"1981-01-12\"\n    }\n  }, {\n    \"fullUrl\": \"Practitioner/Practitioner-01\",\n    \"resource\": {\n      \"resourceType\": \"Practitioner\",\n      \"id\": \"Practitioner-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2019-05-29T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Practitioner\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Dr. GHI, MD (Medicine)</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MD\",\n            \"display\": \"Medical License number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/DigiDoc\",\n        \"value\": \"7601003178999\"\n      } ],\n      \"name\": [ {\n        \"text\": \"Dr. GHI\"\n      } ]\n    }\n  }, \n  {\n    \"fullUrl\": \"Binary/Binary-01\",\n    \"resource\": {\n      \"resourceType\": \"Binary\",\n      \"id\": \"Binary-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Binary\" ]\n      },\n      \"contentType\": \"application/pdf\",\n      \"data\": \"JVBERi0xLjcKJeLjz9MKNSAwIG9iago8PC9GaWx0ZXIvRmxhdGVEZWNvZGUvTGVuZ3RoIDYwMT4+c3RyZWFtCnicpZTBc6IwGMXv/BXfkc5oJCEJ0NOyaq0ddbuF6czOeKGattlBYgPa+t9vAnZlqe1l4QST33uPl3y8ON9TZ3CFgXiQPjqEYMQjCEKMQh/SteOONILbeDaL76dwE4+u4/uL9LczTp2fzkvDEghrlIWIGpSHKAhq9Ig1FCbfJvN4OkPDH/Ougn9UoARFFALGEMa1wnw4hYWCS4hnA+LhMBlmAMl8+M/LwU2fBC1JD+x9N3EIvDo+h4BGiGHYOIxF7w+5k5zsKeD64yk1i/0A+Y35KKuEcfGivuf3iUdINzYDzC1nPbCHOLUYgVQ7HmK+uYy/e5tVUhQVLLKNVVuMruemz3Q6XqRdPX7S42F0jNHVi5+sDPHhVxcPANN3nIUtlnLOA8smh822UpsSLrtsCJi8s9QcgaaBK7EXugdJLsQWtlo95GJTdtGoZYsJ8qJzzrda7WUpVZHlMJLZU6FKeSaG2Ye/OVjEUHOORqJ42oke3Ett8AetitWzrGTZg0lWVlqZeoW2Lz7I4VM2xinCZ7PNxVquzC6p4kwg0gpEAxTUCm5cZTp7g+Zaul6/vpcX8GaeYJ0dBuXywmq58KWi76Fmyr5eZmoNG9+yes5yWcCdKLe7XPx3AmpK/iyBfyqPcnL89G558XovV+JMcbRlQjmqZ8OdyL2AbW427ADqEZTdz8d8J9cl6kEqNluhs2qnBWixUnoN9vwdoJRv8Kx2ukQfXNjRxY4u9UIUtX88n/yvzJA1885oaIfsxH3sgLd+DX7kI0rqhUs3XoyT9HqcTOOm5pr6Ayb0REEKZW5kc3RyZWFtCmVuZG9iago0IDAgb2JqCjw8L0NvbnRlbnRzIDUgMCBSL01lZGlhQm94WzAgMCA1OTUgODQyXS9QYXJlbnQgMiAwIFIvUmVzb3VyY2VzPDwvRm9udDw8L0YxIDYgMCBSL0YxMCAxNSAwIFIvRjExIDE2IDAgUi9GMTIgMTcgMCBSL0YxMyAxOCAwIFIvRjE0IDE5IDAgUi9GMTUgMjAgMCBSL0YxNiAyMSAwIFIvRjIgNyAwIFIvRjMgOCAwIFIvRjQgOSAwIFIvRjUgMTAgMCBSL0Y2IDExIDAgUi9GNyAxMiAwIFIvRjggMTMgMCBSL0Y5IDE0IDAgUj4+Pj4vVHJpbUJveFswIDAgNTk1IDg0Ml0vVHlwZS9QYWdlPj4KZW5kb2JqCjEgMCBvYmoKPDwvUGFnZXMgMiAwIFIvVHlwZS9DYXRhbG9nPj4KZW5kb2JqCjMgMCBvYmoKPDwvQ3JlYXRpb25EYXRlKEQ6MjAyMjAzMDkxNTI4NTArMDUnMzAnKS9Nb2REYXRlKEQ6MjAyMjAzMDkxNTI4NTArMDUnMzAnKS9Qcm9kdWNlcihpVGV4dK4gNy4wLjQgqTIwMDAtMjAxNyBpVGV4dCBHcm91cCBOViBcKEFHUEwtdmVyc2lvblwpKT4+CmVuZG9iagoyMSAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMjAgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE5IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxOCAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTcgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE2IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxNSAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTQgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjEzIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxMiAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTEgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjEwIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iago5IDAgb2JqCjw8L0Jhc2VGb250L0NvdXJpZXItQm9sZC9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKOCAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKNyAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKNiAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMiAwIG9iago8PC9Db3VudCAxL0tpZHNbNCAwIFJdL1R5cGUvUGFnZXM+PgplbmRvYmoKeHJlZgowIDIyCjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMDk3MCAwMDAwMCBuIAowMDAwMDAyNjI1IDAwMDAwIG4gCjAwMDAwMDEwMTUgMDAwMDAgbiAKMDAwMDAwMDY4MyAwMDAwMCBuIAowMDAwMDAwMDE1IDAwMDAwIG4gCjAwMDAwMDI1MzUgMDAwMDAgbiAKMDAwMDAwMjQ0NSAwMDAwMCBuIAowMDAwMDAyMzU1IDAwMDAwIG4gCjAwMDAwMDIyNjQgMDAwMDAgbiAKMDAwMDAwMjE3MyAwMDAwMCBuIAowMDAwMDAyMDgyIDAwMDAwIG4gCjAwMDAwMDE5OTEgMDAwMDAgbiAKMDAwMDAwMTkwMCAwMDAwMCBuIAowMDAwMDAxODA5IDAwMDAwIG4gCjAwMDAwMDE3MTggMDAwMDAgbiAKMDAwMDAwMTYyNyAwMDAwMCBuIAowMDAwMDAxNTM2IDAwMDAwIG4gCjAwMDAwMDE0NDUgMDAwMDAgbiAKMDAwMDAwMTM1NCAwMDAwMCBuIAowMDAwMDAxMjYzIDAwMDAwIG4gCjAwMDAwMDExNzIgMDAwMDAgbiAKdHJhaWxlcgo8PC9JRCBbPDFlMTYyMDM2MGZiZTVhZTZkNmY0MjkwNmIxYTQyOTAwPjwxZTE2MjAzNjBmYmU1YWU2ZDZmNDI5MDZiMWE0MjkwMD5dL0luZm8gMyAwIFIvUm9vdCAxIDAgUi9TaXplIDIyPj4KJWlUZXh0LTcuMC40CnN0YXJ0eHJlZgoyNjc2CiUlRU9GCg==\"\n    }\n  } ]\n}";

		String fhirNewDate = "{\n  \"resourceType\": \"Bundle\",\n  \"id\": \"prescription-bundle-01\",\n  \"meta\": {\n    \"versionId\": \"1\",\n    \"lastUpdated\": \"2022-01-21T15:32:26.605+05:30\",\n    \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/DocumentBundle\" ],\n    \"security\": [ {\n      \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n      \"code\": \"V\",\n      \"display\": \"very restricted\"\n    } ]\n  },\n  \"identifier\": {\n    \"system\": \"http://hip.in\",\n    \"value\": \"bc3c6c57-2053-4d0e-ac40-139ccccff645\"\n  },\n  \"type\": \"document\",\n  \"timestamp\": \"2022-01-21T15:32:26.605+05:30\",\n  \"entry\": [ {\n    \"fullUrl\": \"Composition/Composition-01\",\n    \"resource\": {\n      \"resourceType\": \"Composition\",\n      \"id\": \"Composition-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2022-01-21T15:32:26.605+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/PrescriptionRecord\" ]\n      },\n      \"language\": \"en-IN\",\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Prescription report</div>\"\n      },\n      \"identifier\": {\n        \"system\": \"https://ndhm.in/phr\",\n        \"value\": \"645bb0c3-ff7e-4123-bef5-3852a4784813\"\n      },\n      \"status\": \"final\",\n      \"type\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"440545006\",\n          \"display\": \"Prescription record\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      },\n      \"date\": \"2022-01-21T11:46:09+05:30\",\n      \"author\": [ {\n        \"reference\": \"Practitioner/Practitioner-01\"\n      } ],\n      \"title\": \"Prescription record\",\n      \"section\": [ {\n        \"title\": \"Prescription record\",\n        \"code\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"440545006\",\n            \"display\": \"Prescription record\"\n          } ]\n        },\n        \"entry\": [ {\n          \"reference\": \"MedicationRequest/MedicationRequest-01\",\n          \"type\": \"MedicationRequest\"\n        }, {\n          \"reference\": \"Binary/Binary-01\",\n          \"type\": \"Binary\"\n        } ]\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Patient/Patient-01\",\n    \"resource\": {\n      \"resourceType\": \"Patient\",\n      \"id\": \"Patient-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2022-01-21T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Patient\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">ABC, 41 year, Male</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MR\",\n            \"display\": \"Medical record number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/SwasthID\",\n        \"value\": \"1234\"\n      } ],\n      \"name\": [ {\n        \"text\": \"ABC\"\n      } ],\n      \"telecom\": [ {\n        \"system\": \"phone\",\n        \"value\": \"+919818512600\",\n        \"use\": \"home\"\n      } ],\n      \"gender\": \"male\",\n      \"birthDate\": \"1981-01-12\"\n    }\n  }, {\n    \"fullUrl\": \"Practitioner/Practitioner-01\",\n    \"resource\": {\n      \"resourceType\": \"Practitioner\",\n      \"id\": \"Practitioner-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2019-05-29T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Practitioner\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Dr. DEF, MD (Medicine)</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MD\",\n            \"display\": \"Medical License number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/DigiDoc\",\n        \"value\": \"7601003178999\"\n      } ],\n      \"name\": [ {\n        \"text\": \"Dr. DEF\"\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"MedicationRequest/MedicationRequest-01\",\n    \"resource\": {\n      \"resourceType\": \"MedicationRequest\",\n      \"id\": \"MedicationRequest-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/MedicationRequest\" ]\n      },\n      \"status\": \"active\",\n      \"intent\": \"order\",\n      \"medicationCodeableConcept\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"324252006\",\n          \"display\": \"Azithromycin (as azithromycin dihydrate) 250 mg oral capsule\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\",\n        \"display\": \"ABC\"\n      },\n      \"authoredOn\": \"2022-01-21\",\n      \"requester\": {\n        \"reference\": \"Practitioner/Practitioner-01\",\n        \"display\": \"Dr DEF\"\n      },\n      \"reasonCode\": [ {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"11840006\",\n          \"display\": \"Traveller's Diarrhea (disorder)\"\n        } ]\n      } ],\n      \"reasonReference\": [ {\n        \"reference\": \"Condition/Condition-01\"\n      } ],\n      \"dosageInstruction\": [ {\n        \"text\": \"One tablet at once\",\n        \"additionalInstruction\": [ {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"311504000\",\n            \"display\": \"With or after food\"\n          } ]\n        } ],\n        \"timing\": {\n          \"repeat\": {\n            \"frequency\": 1,\n            \"period\": 1,\n            \"periodUnit\": \"d\"\n          }\n        },\n        \"route\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"26643006\",\n            \"display\": \"Oral Route\"\n          } ]\n        },\n        \"method\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"421521009\",\n            \"display\": \"Swallow\"\n          } ]\n        }\n      } ]\n    }\n  },{\n    \"fullUrl\": \"Condition/Condition-01\",\n    \"resource\": {\n      \"resourceType\": \"Condition\",\n      \"id\": \"Condition-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Condition\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Abdominal pain on 09-July 2020</div>\"\n      },\n      \"code\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"21522001\",\n          \"display\": \"Abdominal pain\"\n        } ],\n        \"text\": \"Abdominal pain\"\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      }\n    }\n  }, {\n    \"fullUrl\": \"Binary/Binary-01\",\n    \"resource\": {\n      \"resourceType\": \"Binary\",\n      \"id\": \"Binary-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Binary\" ]\n      },\n      \"contentType\": \"application/pdf\",\n      \"data\": \"JVBERi0xLjcKJeLjz9MKNSAwIG9iago8PC9GaWx0ZXIvRmxhdGVEZWNvZGUvTGVuZ3RoIDYyOT4+c3RyZWFtCnicfZRdc6IwFIbv+RXn0s7UlIQkQK+WtV92xXYLNzvjTSrRZleIBXR1f/0mYiuD7ILjBD3Pec8bzsm78zV1ru4wEBfShUOoj/wQ/ACjwIM0cwY3JYLHp4cpJPE4fbhIfzq3qfPdeW84AsEBCxjyAvB5gHz/gFnky30cjSdo9BR3Me+IMYKIDz5jCOMDFo/GMNVwDWYxfEyGLgYjPGp+M4vHxMWtZC7Y++XeIfDb8Tj4NEQMQ+4wFn48rJzkJEwBH3xSaoI9H3mN7I2opRFwvaH5EJeQbsEMMLec1cAu4tRiBNLScRHzzGX0B8+iVrKoYSpymy36ljxEP7qZ+CkTD8JjAd1M0dImMFtzhvuA6QfOghZLOee+ZZN9vq51XsF1lw0Akw+WYsQb73dyK8tuaNiSwQS5YZ/Sc6m3qlK6ECu4UWJZ6Er1yJod/9RlIUNNg0xEuS+WqlbVWTw+iTNOEe4Vj2Wm5mbDddGjSFqKTUdbyVS8oljs6lKAWYK5THdFi1qWEEvjYTbAQ9fceHYBO/PEIBP7q2p2YfMP4L8qnouaeTkP8052aGiK6X1rUbZVc9ljhZ5EqJlKr7EyKvVcFTAXBbxKKOVamg7OwL7KPSz0poQ381WhS4iq+k2sTOxUvm5W6o8xW2sLLdVWFkeiUrsGAFEDcBD5pZWdal1c/sN8uy7uoaCpi8PaoKLI7L+xygq1fKtNFanM17IU9aa01c51mXWVbalbrTLQm7pSmYRNMdf6lzG10DoDVcu8QmdVsGMVdp4p4Yh+Hj7955WZveYAYJijMGwx5w5566ygZuhDcgicDaLJ5PblfpykTWccoL+nOUwbCmVuZHN0cmVhbQplbmRvYmoKNCAwIG9iago8PC9Db250ZW50cyA1IDAgUi9NZWRpYUJveFswIDAgNTk1IDg0Ml0vUGFyZW50IDIgMCBSL1Jlc291cmNlczw8L0ZvbnQ8PC9GMSA2IDAgUi9GMTAgMTUgMCBSL0YxMSAxNiAwIFIvRjEyIDE3IDAgUi9GMTMgMTggMCBSL0YxNCAxOSAwIFIvRjE1IDIwIDAgUi9GMTYgMjEgMCBSL0YyIDcgMCBSL0YzIDggMCBSL0Y0IDkgMCBSL0Y1IDEwIDAgUi9GNiAxMSAwIFIvRjcgMTIgMCBSL0Y4IDEzIDAgUi9GOSAxNCAwIFI+Pj4+L1RyaW1Cb3hbMCAwIDU5NSA4NDJdL1R5cGUvUGFnZT4+CmVuZG9iagoxIDAgb2JqCjw8L1BhZ2VzIDIgMCBSL1R5cGUvQ2F0YWxvZz4+CmVuZG9iagozIDAgb2JqCjw8L0NyZWF0aW9uRGF0ZShEOjIwMjIwMzAzMTA1ODU1KzA1JzMwJykvTW9kRGF0ZShEOjIwMjIwMzAzMTA1ODU1KzA1JzMwJykvUHJvZHVjZXIoaVRleHSuIDcuMC40IKkyMDAwLTIwMTcgaVRleHQgR3JvdXAgTlYgXChBR1BMLXZlcnNpb25cKSk+PgplbmRvYmoKMjEgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjIwIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxOSAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTggMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE3IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxNiAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTUgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE0IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxMyAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTIgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjExIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxMCAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKOSAwIG9iago8PC9CYXNlRm9udC9Db3VyaWVyLUJvbGQvRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjggMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjcgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjYgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjIgMCBvYmoKPDwvQ291bnQgMS9LaWRzWzQgMCBSXS9UeXBlL1BhZ2VzPj4KZW5kb2JqCnhyZWYKMCAyMgowMDAwMDAwMDAwIDY1NTM1IGYgCjAwMDAwMDA5OTggMDAwMDAgbiAKMDAwMDAwMjY1MyAwMDAwMCBuIAowMDAwMDAxMDQzIDAwMDAwIG4gCjAwMDAwMDA3MTEgMDAwMDAgbiAKMDAwMDAwMDAxNSAwMDAwMCBuIAowMDAwMDAyNTYzIDAwMDAwIG4gCjAwMDAwMDI0NzMgMDAwMDAgbiAKMDAwMDAwMjM4MyAwMDAwMCBuIAowMDAwMDAyMjkyIDAwMDAwIG4gCjAwMDAwMDIyMDEgMDAwMDAgbiAKMDAwMDAwMjExMCAwMDAwMCBuIAowMDAwMDAyMDE5IDAwMDAwIG4gCjAwMDAwMDE5MjggMDAwMDAgbiAKMDAwMDAwMTgzNyAwMDAwMCBuIAowMDAwMDAxNzQ2IDAwMDAwIG4gCjAwMDAwMDE2NTUgMDAwMDAgbiAKMDAwMDAwMTU2NCAwMDAwMCBuIAowMDAwMDAxNDczIDAwMDAwIG4gCjAwMDAwMDEzODIgMDAwMDAgbiAKMDAwMDAwMTI5MSAwMDAwMCBuIAowMDAwMDAxMjAwIDAwMDAwIG4gCnRyYWlsZXIKPDwvSUQgWzxmMDI1YWY0NzQ5MjBkZjBmOGFlZTRhMmE4MTM2ZTc5OT48ZjAyNWFmNDc0OTIwZGYwZjhhZWU0YTJhODEzNmU3OTk+XS9JbmZvIDMgMCBSL1Jvb3QgMSAwIFIvU2l6ZSAyMj4+CiVpVGV4dC03LjAuNApzdGFydHhyZWYKMjcwNAolJUVPRgo=\"\n    }\n  } ]\n}";

		KeyMaterialDTO receiverKeyMaterial = dataRequestDTO.getHiRequest().getKeyMaterial();
		KeyMaterial senderKeyMaterial = keysGenerator.generate();

		List<EntryDTO> entryDTOS = new ArrayList<>();
		EncryptionResponse encryptionResponse = null;

		for (String careContextNum : fhirMap.keySet()) {
			for (String fhirString : fhirMap.get(careContextNum)) {

				EncryptionRequest encryptionRequest = new EncryptionRequest(
						receiverKeyMaterial.getDhPublicKey().getKeyValue(), receiverKeyMaterial.getNonce(),
						senderKeyMaterial.getPrivateKey(), senderKeyMaterial.getPublicKey(),
						senderKeyMaterial.getNonce(), fhirString);

				encryptionResponse = encryption.encrypt(encryptionRequest);
				entryDTOS.add(EntryDTO.builder().content(encryptionResponse.getEncryptedData())
						.media("application/fhir+json").checksum("").careContextReference(careContextNum).build());
			}
		}

	 
	 

		/*
		 * EncryptionRequest encryptionRequest = new
		 * EncryptionRequest(receiverKeyMaterial.getDhPublicKey().getKeyValue(),
		 * receiverKeyMaterial.getNonce(), senderKeyMaterial.getPrivateKey(),
		 * senderKeyMaterial.getPublicKey(), senderKeyMaterial.getNonce(), fhirNewDate);
		 * 
		 * EncryptionResponse encryptionResponse =
		 * encryption.encrypt(encryptionRequest);
		 * 
		 * EntryDTO entryDTO =
		 * EntryDTO.builder().content(encryptionResponse.getEncryptedData())
		 * .media("application/fhir+json").checksum("").careContextReference(
		 * "CARE_CNTX_12036").build();
		 * 
		 * logger.info("ReceiverKeyMaterialDTO {}", receiverKeyMaterial);
		 * logger.info("SenderKeyMaterialDTO {}", senderKeyMaterial);
		 * logger.info("KeyToShare {}", encryptionResponse.getKeyToShare());
		 */

		KeyMaterialDTO keyMaterialDTO = KeyMaterialDTO.builder().cryptoAlg(receiverKeyMaterial.getCryptoAlg())
				.curve(receiverKeyMaterial.getCurve())
				.dhPublicKey(DhPublicKeyDTO.builder().expiry(expiryDate)
						.parameters(receiverKeyMaterial.getDhPublicKey().getParameters())
						.keyValue(encryptionResponse.getKeyToShare()).build())
				.nonce(senderKeyMaterial.getNonce()).build();

		logger.info("prepareDataNewDTO ends");
		/*
		 * logger.info("dataRequestDTO.getTransactionId() {}",
		 * dataRequestDTO.getTransactionId());
		 */
		return DataTransferDTO.builder().pageCount(1).pageNumber(1).transactionId(dataRequestDTO.getTransactionId())
				.entries(entryDTOS).keyMaterial(keyMaterialDTO).build();
	}

	private DataTransferDTO dataTransferDummy(DataRequestDTO dataRequestDTO) throws Exception {
		logger.info("dataTransferDummy starts");

		String fhirOriginal = "{\n  \"resourceType\": \"Bundle\",\n  \"id\": \"prescription-bundle-01\",\n  \"meta\": {\n    \"versionId\": \"1\",\n    \"lastUpdated\": \"2020-07-09T15:32:26.605+05:30\",\n    \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/DocumentBundle\" ],\n    \"security\": [ {\n      \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n      \"code\": \"V\",\n      \"display\": \"very restricted\"\n    } ]\n  },\n  \"identifier\": {\n    \"system\": \"http://hip.in\",\n    \"value\": \"bc3c6c57-2053-4d0e-ac40-139ccccff645\"\n  },\n  \"type\": \"document\",\n  \"timestamp\": \"2020-07-09T15:32:26.605+05:30\",\n  \"entry\": [ {\n    \"fullUrl\": \"Composition/Composition-01\",\n    \"resource\": {\n      \"resourceType\": \"Composition\",\n      \"id\": \"Composition-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2020-07-09T15:32:26.605+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/PrescriptionRecord\" ]\n      },\n      \"language\": \"en-IN\",\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Prescription report</div>\"\n      },\n      \"identifier\": {\n        \"system\": \"https://ndhm.in/phr\",\n        \"value\": \"645bb0c3-ff7e-4123-bef5-3852a4784813\"\n      },\n      \"status\": \"final\",\n      \"type\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"440545006\",\n          \"display\": \"Prescription record\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      },\n      \"date\": \"2017-05-27T11:46:09+05:30\",\n      \"author\": [ {\n        \"reference\": \"Practitioner/Practitioner-01\"\n      } ],\n      \"title\": \"Prescription record\",\n      \"section\": [ {\n        \"title\": \"Prescription record\",\n        \"code\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"440545006\",\n            \"display\": \"Prescription record\"\n          } ]\n        },\n        \"entry\": [ {\n          \"reference\": \"MedicationRequest/MedicationRequest-01\",\n          \"type\": \"MedicationRequest\"\n        }, {\n          \"reference\": \"MedicationRequest/MedicationRequest-02\",\n          \"type\": \"MedicationRequest\"\n        }, {\n          \"reference\": \"Binary/Binary-01\",\n          \"type\": \"Binary\"\n        } ]\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Patient/Patient-01\",\n    \"resource\": {\n      \"resourceType\": \"Patient\",\n      \"id\": \"Patient-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2020-07-09T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Patient\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">ABC, 41 year, Male</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MR\",\n            \"display\": \"Medical record number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/SwasthID\",\n        \"value\": \"1234\"\n      } ],\n      \"name\": [ {\n        \"text\": \"ABC\"\n      } ],\n      \"telecom\": [ {\n        \"system\": \"phone\",\n        \"value\": \"+919818512600\",\n        \"use\": \"home\"\n      } ],\n      \"gender\": \"male\",\n      \"birthDate\": \"1981-01-12\"\n    }\n  }, {\n    \"fullUrl\": \"Practitioner/Practitioner-01\",\n    \"resource\": {\n      \"resourceType\": \"Practitioner\",\n      \"id\": \"Practitioner-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2019-05-29T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Practitioner\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Dr. DEF, MD (Medicine)</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MD\",\n            \"display\": \"Medical License number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/DigiDoc\",\n        \"value\": \"7601003178999\"\n      } ],\n      \"name\": [ {\n        \"text\": \"Dr. DEF\"\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"MedicationRequest/MedicationRequest-01\",\n    \"resource\": {\n      \"resourceType\": \"MedicationRequest\",\n      \"id\": \"MedicationRequest-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/MedicationRequest\" ]\n      },\n      \"status\": \"active\",\n      \"intent\": \"order\",\n      \"medicationCodeableConcept\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"324252006\",\n          \"display\": \"Azithromycin (as azithromycin dihydrate) 250 mg oral capsule\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\",\n        \"display\": \"ABC\"\n      },\n      \"authoredOn\": \"2020-07-09\",\n      \"requester\": {\n        \"reference\": \"Practitioner/Practitioner-01\",\n        \"display\": \"Dr DEF\"\n      },\n      \"reasonCode\": [ {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"11840006\",\n          \"display\": \"Traveller\'s Diarrhea (disorder)\"\n        } ]\n      } ],\n      \"reasonReference\": [ {\n        \"reference\": \"Condition/Condition-01\"\n      } ],\n      \"dosageInstruction\": [ {\n        \"text\": \"One tablet at once\",\n        \"additionalInstruction\": [ {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"311504000\",\n            \"display\": \"With or after food\"\n          } ]\n        } ],\n        \"timing\": {\n          \"repeat\": {\n            \"frequency\": 1,\n            \"period\": 1,\n            \"periodUnit\": \"d\"\n          }\n        },\n        \"route\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"26643006\",\n            \"display\": \"Oral Route\"\n          } ]\n        },\n        \"method\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"421521009\",\n            \"display\": \"Swallow\"\n          } ]\n        }\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"MedicationRequest/MedicationRequest-02\",\n    \"resource\": {\n      \"resourceType\": \"MedicationRequest\",\n      \"id\": \"MedicationRequest-02\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/MedicationRequest\" ]\n      },\n      \"status\": \"active\",\n      \"intent\": \"order\",\n      \"medicationCodeableConcept\": {\n        \"text\": \"Paracetemol 500mg Oral Tab\"\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\",\n        \"display\": \"ABC\"\n      },\n      \"authoredOn\": \"2020-07-09\",\n      \"requester\": {\n        \"reference\": \"Practitioner/Practitioner-01\",\n        \"display\": \"Dr DEF\"\n      },\n      \"reasonCode\": [ {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"602001\",\n          \"display\": \"Ross river fever\"\n        } ]\n      } ],\n      \"reasonReference\": [ {\n        \"reference\": \"Condition/Condition-01\"\n      } ],\n      \"dosageInstruction\": [ {\n        \"text\": \"Take two tablets orally with or after meal once a day\"\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Condition/Condition-01\",\n    \"resource\": {\n      \"resourceType\": \"Condition\",\n      \"id\": \"Condition-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Condition\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Abdominal pain on 09-July 2020</div>\"\n      },\n      \"code\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"21522001\",\n          \"display\": \"Abdominal pain\"\n        } ],\n        \"text\": \"Abdominal pain\"\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      }\n    }\n  }, {\n    \"fullUrl\": \"Binary/Binary-01\",\n    \"resource\": {\n      \"resourceType\": \"Binary\",\n      \"id\": \"Binary-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Binary\" ]\n      },\n      \"contentType\": \"application/pdf\",\n      \"data\": \"R0lGODlhfgCRAPcAAAAAAIAAAACAAICAAAAAgIAAoxrXyMY2uvGNcIyjHOeoxkXBh44OOZdn8Ggu+DiPjwtJ2CZyUomCTRGO\"\n    }\n  } ]\n}";

		String fhirNew = "{\n  \"resourceType\": \"Bundle\",\n  \"id\": \"prescription-bundle-02\",\n  \"meta\": {\n    \"versionId\": \"1\",\n    \"lastUpdated\": \"2020-07-09T15:32:26.605+05:30\",\n    \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/DocumentBundle\" ],\n    \"security\": [ {\n      \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n      \"code\": \"V\",\n      \"display\": \"very restricted\"\n    } ]\n  },\n  \"identifier\": {\n    \"system\": \"http://hip.in\",\n    \"value\": \"bc3c6c57-2053-4d0e-ac40-139ccccff645\"\n  },\n  \"type\": \"document\",\n  \"timestamp\": \"2020-07-09T15:32:26.605+05:30\",\n  \"entry\": [ {\n    \"fullUrl\": \"Composition/Composition-01\",\n    \"resource\": {\n      \"resourceType\": \"Composition\",\n      \"id\": \"Composition-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2020-07-09T15:32:26.605+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/PrescriptionRecord\" ]\n      },\n      \"language\": \"en-IN\",\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Prescription report</div>\"\n      },\n      \"identifier\": {\n        \"system\": \"https://ndhm.in/phr\",\n        \"value\": \"645bb0c3-ff7e-4123-bef5-3852a4784813\"\n      },\n      \"status\": \"final\",\n      \"type\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"440545006\",\n          \"display\": \"Prescription record\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      },\n      \"date\": \"2017-05-27T11:46:09+05:30\",\n      \"author\": [ {\n        \"reference\": \"Practitioner/Practitioner-01\"\n      } ],\n      \"title\": \"Prescription record\",\n      \"section\": [ {\n        \"title\": \"Prescription record\",\n        \"code\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"440545006\",\n            \"display\": \"Prescription record\"\n          } ]\n        },\n        \"entry\": [ \n\t\t{\n          \"reference\": \"Binary/Binary-01\",\n          \"type\": \"Binary\"\n        } ]\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Patient/Patient-01\",\n    \"resource\": {\n      \"resourceType\": \"Patient\",\n      \"id\": \"Patient-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2020-07-09T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Patient\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">ABC, 41 year, Male</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MR\",\n            \"display\": \"Medical record number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/SwasthID\",\n        \"value\": \"1234\"\n      } ],\n      \"name\": [ {\n        \"text\": \"ABC\"\n      } ],\n      \"telecom\": [ {\n        \"system\": \"phone\",\n        \"value\": \"+919818512600\",\n        \"use\": \"home\"\n      } ],\n      \"gender\": \"male\",\n      \"birthDate\": \"1981-01-12\"\n    }\n  }, {\n    \"fullUrl\": \"Practitioner/Practitioner-01\",\n    \"resource\": {\n      \"resourceType\": \"Practitioner\",\n      \"id\": \"Practitioner-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2019-05-29T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Practitioner\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Dr. GHI, MD (Medicine)</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MD\",\n            \"display\": \"Medical License number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/DigiDoc\",\n        \"value\": \"7601003178999\"\n      } ],\n      \"name\": [ {\n        \"text\": \"Dr. GHI\"\n      } ]\n    }\n  }, \n  {\n    \"fullUrl\": \"Binary/Binary-01\",\n    \"resource\": {\n      \"resourceType\": \"Binary\",\n      \"id\": \"Binary-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Binary\" ]\n      },\n      \"contentType\": \"application/pdf\",\n      \"data\": \"JVBERi0xLjcKJeLjz9MKNSAwIG9iago8PC9GaWx0ZXIvRmxhdGVEZWNvZGUvTGVuZ3RoIDYwMT4+c3RyZWFtCnicpZTBc6IwGMXv/BXfkc5oJCEJ0NOyaq0ddbuF6czOeKGattlBYgPa+t9vAnZlqe1l4QST33uPl3y8ON9TZ3CFgXiQPjqEYMQjCEKMQh/SteOONILbeDaL76dwE4+u4/uL9LczTp2fzkvDEghrlIWIGpSHKAhq9Ig1FCbfJvN4OkPDH/Ougn9UoARFFALGEMa1wnw4hYWCS4hnA+LhMBlmAMl8+M/LwU2fBC1JD+x9N3EIvDo+h4BGiGHYOIxF7w+5k5zsKeD64yk1i/0A+Y35KKuEcfGivuf3iUdINzYDzC1nPbCHOLUYgVQ7HmK+uYy/e5tVUhQVLLKNVVuMruemz3Q6XqRdPX7S42F0jNHVi5+sDPHhVxcPANN3nIUtlnLOA8smh822UpsSLrtsCJi8s9QcgaaBK7EXugdJLsQWtlo95GJTdtGoZYsJ8qJzzrda7WUpVZHlMJLZU6FKeSaG2Ye/OVjEUHOORqJ42oke3Ett8AetitWzrGTZg0lWVlqZeoW2Lz7I4VM2xinCZ7PNxVquzC6p4kwg0gpEAxTUCm5cZTp7g+Zaul6/vpcX8GaeYJ0dBuXywmq58KWi76Fmyr5eZmoNG9+yes5yWcCdKLe7XPx3AmpK/iyBfyqPcnL89G558XovV+JMcbRlQjmqZ8OdyL2AbW427ADqEZTdz8d8J9cl6kEqNluhs2qnBWixUnoN9vwdoJRv8Kx2ukQfXNjRxY4u9UIUtX88n/yvzJA1885oaIfsxH3sgLd+DX7kI0rqhUs3XoyT9HqcTOOm5pr6Ayb0REEKZW5kc3RyZWFtCmVuZG9iago0IDAgb2JqCjw8L0NvbnRlbnRzIDUgMCBSL01lZGlhQm94WzAgMCA1OTUgODQyXS9QYXJlbnQgMiAwIFIvUmVzb3VyY2VzPDwvRm9udDw8L0YxIDYgMCBSL0YxMCAxNSAwIFIvRjExIDE2IDAgUi9GMTIgMTcgMCBSL0YxMyAxOCAwIFIvRjE0IDE5IDAgUi9GMTUgMjAgMCBSL0YxNiAyMSAwIFIvRjIgNyAwIFIvRjMgOCAwIFIvRjQgOSAwIFIvRjUgMTAgMCBSL0Y2IDExIDAgUi9GNyAxMiAwIFIvRjggMTMgMCBSL0Y5IDE0IDAgUj4+Pj4vVHJpbUJveFswIDAgNTk1IDg0Ml0vVHlwZS9QYWdlPj4KZW5kb2JqCjEgMCBvYmoKPDwvUGFnZXMgMiAwIFIvVHlwZS9DYXRhbG9nPj4KZW5kb2JqCjMgMCBvYmoKPDwvQ3JlYXRpb25EYXRlKEQ6MjAyMjAzMDkxNTI4NTArMDUnMzAnKS9Nb2REYXRlKEQ6MjAyMjAzMDkxNTI4NTArMDUnMzAnKS9Qcm9kdWNlcihpVGV4dK4gNy4wLjQgqTIwMDAtMjAxNyBpVGV4dCBHcm91cCBOViBcKEFHUEwtdmVyc2lvblwpKT4+CmVuZG9iagoyMSAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMjAgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE5IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxOCAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTcgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE2IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxNSAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTQgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjEzIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxMiAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTEgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjEwIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iago5IDAgb2JqCjw8L0Jhc2VGb250L0NvdXJpZXItQm9sZC9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKOCAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKNyAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKNiAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMiAwIG9iago8PC9Db3VudCAxL0tpZHNbNCAwIFJdL1R5cGUvUGFnZXM+PgplbmRvYmoKeHJlZgowIDIyCjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMDk3MCAwMDAwMCBuIAowMDAwMDAyNjI1IDAwMDAwIG4gCjAwMDAwMDEwMTUgMDAwMDAgbiAKMDAwMDAwMDY4MyAwMDAwMCBuIAowMDAwMDAwMDE1IDAwMDAwIG4gCjAwMDAwMDI1MzUgMDAwMDAgbiAKMDAwMDAwMjQ0NSAwMDAwMCBuIAowMDAwMDAyMzU1IDAwMDAwIG4gCjAwMDAwMDIyNjQgMDAwMDAgbiAKMDAwMDAwMjE3MyAwMDAwMCBuIAowMDAwMDAyMDgyIDAwMDAwIG4gCjAwMDAwMDE5OTEgMDAwMDAgbiAKMDAwMDAwMTkwMCAwMDAwMCBuIAowMDAwMDAxODA5IDAwMDAwIG4gCjAwMDAwMDE3MTggMDAwMDAgbiAKMDAwMDAwMTYyNyAwMDAwMCBuIAowMDAwMDAxNTM2IDAwMDAwIG4gCjAwMDAwMDE0NDUgMDAwMDAgbiAKMDAwMDAwMTM1NCAwMDAwMCBuIAowMDAwMDAxMjYzIDAwMDAwIG4gCjAwMDAwMDExNzIgMDAwMDAgbiAKdHJhaWxlcgo8PC9JRCBbPDFlMTYyMDM2MGZiZTVhZTZkNmY0MjkwNmIxYTQyOTAwPjwxZTE2MjAzNjBmYmU1YWU2ZDZmNDI5MDZiMWE0MjkwMD5dL0luZm8gMyAwIFIvUm9vdCAxIDAgUi9TaXplIDIyPj4KJWlUZXh0LTcuMC40CnN0YXJ0eHJlZgoyNjc2CiUlRU9GCg==\"\n    }\n  } ]\n}";

		String fhirNewDate = "{\n  \"resourceType\": \"Bundle\",\n  \"id\": \"prescription-bundle-01\",\n  \"meta\": {\n    \"versionId\": \"1\",\n    \"lastUpdated\": \"2022-01-21T15:32:26.605+05:30\",\n    \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/DocumentBundle\" ],\n    \"security\": [ {\n      \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n      \"code\": \"V\",\n      \"display\": \"very restricted\"\n    } ]\n  },\n  \"identifier\": {\n    \"system\": \"http://hip.in\",\n    \"value\": \"bc3c6c57-2053-4d0e-ac40-139ccccff645\"\n  },\n  \"type\": \"document\",\n  \"timestamp\": \"2022-01-21T15:32:26.605+05:30\",\n  \"entry\": [ {\n    \"fullUrl\": \"Composition/Composition-01\",\n    \"resource\": {\n      \"resourceType\": \"Composition\",\n      \"id\": \"Composition-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2022-01-21T15:32:26.605+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/PrescriptionRecord\" ]\n      },\n      \"language\": \"en-IN\",\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Prescription report</div>\"\n      },\n      \"identifier\": {\n        \"system\": \"https://ndhm.in/phr\",\n        \"value\": \"645bb0c3-ff7e-4123-bef5-3852a4784813\"\n      },\n      \"status\": \"final\",\n      \"type\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"440545006\",\n          \"display\": \"Prescription record\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      },\n      \"date\": \"2022-01-21T11:46:09+05:30\",\n      \"author\": [ {\n        \"reference\": \"Practitioner/Practitioner-01\"\n      } ],\n      \"title\": \"Prescription record\",\n      \"section\": [ {\n        \"title\": \"Prescription record\",\n        \"code\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"440545006\",\n            \"display\": \"Prescription record\"\n          } ]\n        },\n        \"entry\": [ {\n          \"reference\": \"MedicationRequest/MedicationRequest-01\",\n          \"type\": \"MedicationRequest\"\n        }, {\n          \"reference\": \"Binary/Binary-01\",\n          \"type\": \"Binary\"\n        } ]\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Patient/Patient-01\",\n    \"resource\": {\n      \"resourceType\": \"Patient\",\n      \"id\": \"Patient-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2022-01-21T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Patient\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">ABC, 41 year, Male</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MR\",\n            \"display\": \"Medical record number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/SwasthID\",\n        \"value\": \"1234\"\n      } ],\n      \"name\": [ {\n        \"text\": \"ABC\"\n      } ],\n      \"telecom\": [ {\n        \"system\": \"phone\",\n        \"value\": \"+919818512600\",\n        \"use\": \"home\"\n      } ],\n      \"gender\": \"male\",\n      \"birthDate\": \"1981-01-12\"\n    }\n  }, {\n    \"fullUrl\": \"Practitioner/Practitioner-01\",\n    \"resource\": {\n      \"resourceType\": \"Practitioner\",\n      \"id\": \"Practitioner-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2019-05-29T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Practitioner\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Dr. DEF, MD (Medicine)</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MD\",\n            \"display\": \"Medical License number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/DigiDoc\",\n        \"value\": \"7601003178999\"\n      } ],\n      \"name\": [ {\n        \"text\": \"Dr. DEF\"\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"MedicationRequest/MedicationRequest-01\",\n    \"resource\": {\n      \"resourceType\": \"MedicationRequest\",\n      \"id\": \"MedicationRequest-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/MedicationRequest\" ]\n      },\n      \"status\": \"active\",\n      \"intent\": \"order\",\n      \"medicationCodeableConcept\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"324252006\",\n          \"display\": \"Azithromycin (as azithromycin dihydrate) 250 mg oral capsule\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\",\n        \"display\": \"ABC\"\n      },\n      \"authoredOn\": \"2022-01-21\",\n      \"requester\": {\n        \"reference\": \"Practitioner/Practitioner-01\",\n        \"display\": \"Dr DEF\"\n      },\n      \"reasonCode\": [ {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"11840006\",\n          \"display\": \"Traveller's Diarrhea (disorder)\"\n        } ]\n      } ],\n      \"reasonReference\": [ {\n        \"reference\": \"Condition/Condition-01\"\n      } ],\n      \"dosageInstruction\": [ {\n        \"text\": \"One tablet at once\",\n        \"additionalInstruction\": [ {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"311504000\",\n            \"display\": \"With or after food\"\n          } ]\n        } ],\n        \"timing\": {\n          \"repeat\": {\n            \"frequency\": 1,\n            \"period\": 1,\n            \"periodUnit\": \"d\"\n          }\n        },\n        \"route\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"26643006\",\n            \"display\": \"Oral Route\"\n          } ]\n        },\n        \"method\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"421521009\",\n            \"display\": \"Swallow\"\n          } ]\n        }\n      } ]\n    }\n  },{\n    \"fullUrl\": \"Condition/Condition-01\",\n    \"resource\": {\n      \"resourceType\": \"Condition\",\n      \"id\": \"Condition-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Condition\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Abdominal pain on 09-July 2020</div>\"\n      },\n      \"code\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"21522001\",\n          \"display\": \"Abdominal pain\"\n        } ],\n        \"text\": \"Abdominal pain\"\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      }\n    }\n  }, {\n    \"fullUrl\": \"Binary/Binary-01\",\n    \"resource\": {\n      \"resourceType\": \"Binary\",\n      \"id\": \"Binary-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Binary\" ]\n      },\n      \"contentType\": \"application/pdf\",\n      \"data\": \"JVBERi0xLjcKJeLjz9MKNSAwIG9iago8PC9GaWx0ZXIvRmxhdGVEZWNvZGUvTGVuZ3RoIDYyOT4+c3RyZWFtCnicfZRdc6IwFIbv+RXn0s7UlIQkQK+WtV92xXYLNzvjTSrRZleIBXR1f/0mYiuD7ILjBD3Pec8bzsm78zV1ru4wEBfShUOoj/wQ/ACjwIM0cwY3JYLHp4cpJPE4fbhIfzq3qfPdeW84AsEBCxjyAvB5gHz/gFnky30cjSdo9BR3Me+IMYKIDz5jCOMDFo/GMNVwDWYxfEyGLgYjPGp+M4vHxMWtZC7Y++XeIfDb8Tj4NEQMQ+4wFn48rJzkJEwBH3xSaoI9H3mN7I2opRFwvaH5EJeQbsEMMLec1cAu4tRiBNLScRHzzGX0B8+iVrKoYSpymy36ljxEP7qZ+CkTD8JjAd1M0dImMFtzhvuA6QfOghZLOee+ZZN9vq51XsF1lw0Akw+WYsQb73dyK8tuaNiSwQS5YZ/Sc6m3qlK6ECu4UWJZ6Er1yJod/9RlIUNNg0xEuS+WqlbVWTw+iTNOEe4Vj2Wm5mbDddGjSFqKTUdbyVS8oljs6lKAWYK5THdFi1qWEEvjYTbAQ9fceHYBO/PEIBP7q2p2YfMP4L8qnouaeTkP8052aGiK6X1rUbZVc9ljhZ5EqJlKr7EyKvVcFTAXBbxKKOVamg7OwL7KPSz0poQ381WhS4iq+k2sTOxUvm5W6o8xW2sLLdVWFkeiUrsGAFEDcBD5pZWdal1c/sN8uy7uoaCpi8PaoKLI7L+xygq1fKtNFanM17IU9aa01c51mXWVbalbrTLQm7pSmYRNMdf6lzG10DoDVcu8QmdVsGMVdp4p4Yh+Hj7955WZveYAYJijMGwx5w5566ygZuhDcgicDaLJ5PblfpykTWccoL+nOUwbCmVuZHN0cmVhbQplbmRvYmoKNCAwIG9iago8PC9Db250ZW50cyA1IDAgUi9NZWRpYUJveFswIDAgNTk1IDg0Ml0vUGFyZW50IDIgMCBSL1Jlc291cmNlczw8L0ZvbnQ8PC9GMSA2IDAgUi9GMTAgMTUgMCBSL0YxMSAxNiAwIFIvRjEyIDE3IDAgUi9GMTMgMTggMCBSL0YxNCAxOSAwIFIvRjE1IDIwIDAgUi9GMTYgMjEgMCBSL0YyIDcgMCBSL0YzIDggMCBSL0Y0IDkgMCBSL0Y1IDEwIDAgUi9GNiAxMSAwIFIvRjcgMTIgMCBSL0Y4IDEzIDAgUi9GOSAxNCAwIFI+Pj4+L1RyaW1Cb3hbMCAwIDU5NSA4NDJdL1R5cGUvUGFnZT4+CmVuZG9iagoxIDAgb2JqCjw8L1BhZ2VzIDIgMCBSL1R5cGUvQ2F0YWxvZz4+CmVuZG9iagozIDAgb2JqCjw8L0NyZWF0aW9uRGF0ZShEOjIwMjIwMzAzMTA1ODU1KzA1JzMwJykvTW9kRGF0ZShEOjIwMjIwMzAzMTA1ODU1KzA1JzMwJykvUHJvZHVjZXIoaVRleHSuIDcuMC40IKkyMDAwLTIwMTcgaVRleHQgR3JvdXAgTlYgXChBR1BMLXZlcnNpb25cKSk+PgplbmRvYmoKMjEgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjIwIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxOSAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTggMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE3IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxNiAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTUgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE0IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxMyAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTIgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjExIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxMCAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKOSAwIG9iago8PC9CYXNlRm9udC9Db3VyaWVyLUJvbGQvRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjggMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjcgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjYgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjIgMCBvYmoKPDwvQ291bnQgMS9LaWRzWzQgMCBSXS9UeXBlL1BhZ2VzPj4KZW5kb2JqCnhyZWYKMCAyMgowMDAwMDAwMDAwIDY1NTM1IGYgCjAwMDAwMDA5OTggMDAwMDAgbiAKMDAwMDAwMjY1MyAwMDAwMCBuIAowMDAwMDAxMDQzIDAwMDAwIG4gCjAwMDAwMDA3MTEgMDAwMDAgbiAKMDAwMDAwMDAxNSAwMDAwMCBuIAowMDAwMDAyNTYzIDAwMDAwIG4gCjAwMDAwMDI0NzMgMDAwMDAgbiAKMDAwMDAwMjM4MyAwMDAwMCBuIAowMDAwMDAyMjkyIDAwMDAwIG4gCjAwMDAwMDIyMDEgMDAwMDAgbiAKMDAwMDAwMjExMCAwMDAwMCBuIAowMDAwMDAyMDE5IDAwMDAwIG4gCjAwMDAwMDE5MjggMDAwMDAgbiAKMDAwMDAwMTgzNyAwMDAwMCBuIAowMDAwMDAxNzQ2IDAwMDAwIG4gCjAwMDAwMDE2NTUgMDAwMDAgbiAKMDAwMDAwMTU2NCAwMDAwMCBuIAowMDAwMDAxNDczIDAwMDAwIG4gCjAwMDAwMDEzODIgMDAwMDAgbiAKMDAwMDAwMTI5MSAwMDAwMCBuIAowMDAwMDAxMjAwIDAwMDAwIG4gCnRyYWlsZXIKPDwvSUQgWzxmMDI1YWY0NzQ5MjBkZjBmOGFlZTRhMmE4MTM2ZTc5OT48ZjAyNWFmNDc0OTIwZGYwZjhhZWU0YTJhODEzNmU3OTk+XS9JbmZvIDMgMCBSL1Jvb3QgMSAwIFIvU2l6ZSAyMj4+CiVpVGV4dC03LjAuNApzdGFydHhyZWYKMjcwNAolJUVPRgo=\"\n    }\n  } ]\n}";

		String fhirNewDate2 = "{\n  \"resourceType\": \"Bundle\",\n  \"id\": \"prescription-bundle-01\",\n  \"meta\": {\n    \"versionId\": \"1\",\n    \"lastUpdated\": \"2022-02-21T15:32:26.605+05:30\",\n    \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/DocumentBundle\" ],\n    \"security\": [ {\n      \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n      \"code\": \"V\",\n      \"display\": \"very restricted\"\n    } ]\n  },\n  \"identifier\": {\n    \"system\": \"http://hip.in\",\n    \"value\": \"bc3c6c57-2053-4d0e-ac40-139ccccff645\"\n  },\n  \"type\": \"document\",\n  \"timestamp\": \"2022-02-21T15:32:26.605+05:30\",\n  \"entry\": [ {\n    \"fullUrl\": \"Composition/Composition-01\",\n    \"resource\": {\n      \"resourceType\": \"Composition\",\n      \"id\": \"Composition-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2022-02-21T15:32:26.605+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/PrescriptionRecord\" ]\n      },\n      \"language\": \"en-IN\",\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Prescription report</div>\"\n      },\n      \"identifier\": {\n        \"system\": \"https://ndhm.in/phr\",\n        \"value\": \"645bb0c3-ff7e-4123-bef5-3852a4784813\"\n      },\n      \"status\": \"final\",\n      \"type\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"440545006\",\n          \"display\": \"Prescription record\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      },\n      \"date\": \"2022-02-21T11:46:09+05:30\",\n      \"author\": [ {\n        \"reference\": \"Practitioner/Practitioner-01\"\n      } ],\n      \"title\": \"Prescription record\",\n      \"section\": [ {\n        \"title\": \"Prescription record\",\n        \"code\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"440545006\",\n            \"display\": \"Prescription record\"\n          } ]\n        },\n        \"entry\": [ {\n          \"reference\": \"MedicationRequest/MedicationRequest-01\",\n          \"type\": \"MedicationRequest\"\n        }, {\n          \"reference\": \"Binary/Binary-01\",\n          \"type\": \"Binary\"\n        } ]\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"Patient/Patient-01\",\n    \"resource\": {\n      \"resourceType\": \"Patient\",\n      \"id\": \"Patient-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2022-02-21T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Patient\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">ABC, 41 year, Male</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MR\",\n            \"display\": \"Medical record number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/SwasthID\",\n        \"value\": \"1234\"\n      } ],\n      \"name\": [ {\n        \"text\": \"ABC\"\n      } ],\n      \"telecom\": [ {\n        \"system\": \"phone\",\n        \"value\": \"+919818512600\",\n        \"use\": \"home\"\n      } ],\n      \"gender\": \"male\",\n      \"birthDate\": \"1981-01-12\"\n    }\n  }, {\n    \"fullUrl\": \"Practitioner/Practitioner-01\",\n    \"resource\": {\n      \"resourceType\": \"Practitioner\",\n      \"id\": \"Practitioner-01\",\n      \"meta\": {\n        \"versionId\": \"1\",\n        \"lastUpdated\": \"2019-05-29T14:58:58.181+05:30\",\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Practitioner\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Dr. DEF, MD (Medicine)</div>\"\n      },\n      \"identifier\": [ {\n        \"type\": {\n          \"coding\": [ {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0203\",\n            \"code\": \"MD\",\n            \"display\": \"Medical License number\"\n          } ]\n        },\n        \"system\": \"https://ndhm.in/DigiDoc\",\n        \"value\": \"7601003178999\"\n      } ],\n      \"name\": [ {\n        \"text\": \"Dr. DEF\"\n      } ]\n    }\n  }, {\n    \"fullUrl\": \"MedicationRequest/MedicationRequest-01\",\n    \"resource\": {\n      \"resourceType\": \"MedicationRequest\",\n      \"id\": \"MedicationRequest-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/MedicationRequest\" ]\n      },\n      \"status\": \"active\",\n      \"intent\": \"order\",\n      \"medicationCodeableConcept\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"324252006\",\n          \"display\": \"Azithromycin (as azithromycin dihydrate) 250 mg oral capsule\"\n        } ]\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\",\n        \"display\": \"ABC\"\n      },\n      \"authoredOn\": \"2022-02-21\",\n      \"requester\": {\n        \"reference\": \"Practitioner/Practitioner-01\",\n        \"display\": \"Dr DEF\"\n      },\n      \"reasonCode\": [ {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"11840006\",\n          \"display\": \"Traveller's Diarrhea (disorder)\"\n        } ]\n      } ],\n      \"reasonReference\": [ {\n        \"reference\": \"Condition/Condition-01\"\n      } ],\n      \"dosageInstruction\": [ {\n        \"text\": \"One tablet at once\",\n        \"additionalInstruction\": [ {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"311504000\",\n            \"display\": \"With or after food\"\n          } ]\n        } ],\n        \"timing\": {\n          \"repeat\": {\n            \"frequency\": 1,\n            \"period\": 1,\n            \"periodUnit\": \"d\"\n          }\n        },\n        \"route\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"26643006\",\n            \"display\": \"Oral Route\"\n          } ]\n        },\n        \"method\": {\n          \"coding\": [ {\n            \"system\": \"http://snomed.info/sct\",\n            \"code\": \"421521009\",\n            \"display\": \"Swallow\"\n          } ]\n        }\n      } ]\n    }\n  },{\n    \"fullUrl\": \"Condition/Condition-01\",\n    \"resource\": {\n      \"resourceType\": \"Condition\",\n      \"id\": \"Condition-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Condition\" ]\n      },\n      \"text\": {\n        \"status\": \"generated\",\n        \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\">Abdominal pain on 09-July 2020</div>\"\n      },\n      \"code\": {\n        \"coding\": [ {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"21522001\",\n          \"display\": \"Abdominal pain\"\n        } ],\n        \"text\": \"Abdominal pain\"\n      },\n      \"subject\": {\n        \"reference\": \"Patient/Patient-01\"\n      }\n    }\n  }, {\n    \"fullUrl\": \"Binary/Binary-01\",\n    \"resource\": {\n      \"resourceType\": \"Binary\",\n      \"id\": \"Binary-01\",\n      \"meta\": {\n        \"profile\": [ \"https://nrces.in/ndhm/fhir/r4/StructureDefinition/Binary\" ]\n      },\n      \"contentType\": \"application/pdf\",\n      \"data\": \"JVBERi0xLjcKJeLjz9MKNSAwIG9iago8PC9GaWx0ZXIvRmxhdGVEZWNvZGUvTGVuZ3RoIDYyOT4+c3RyZWFtCnicfZRdc6IwFIbv+RXn0s7UlIQkQK+WtV92xXYLNzvjTSrRZleIBXR1f/0mYiuD7ILjBD3Pec8bzsm78zV1ru4wEBfShUOoj/wQ/ACjwIM0cwY3JYLHp4cpJPE4fbhIfzq3qfPdeW84AsEBCxjyAvB5gHz/gFnky30cjSdo9BR3Me+IMYKIDz5jCOMDFo/GMNVwDWYxfEyGLgYjPGp+M4vHxMWtZC7Y++XeIfDb8Tj4NEQMQ+4wFn48rJzkJEwBH3xSaoI9H3mN7I2opRFwvaH5EJeQbsEMMLec1cAu4tRiBNLScRHzzGX0B8+iVrKoYSpymy36ljxEP7qZ+CkTD8JjAd1M0dImMFtzhvuA6QfOghZLOee+ZZN9vq51XsF1lw0Akw+WYsQb73dyK8tuaNiSwQS5YZ/Sc6m3qlK6ECu4UWJZ6Er1yJod/9RlIUNNg0xEuS+WqlbVWTw+iTNOEe4Vj2Wm5mbDddGjSFqKTUdbyVS8oljs6lKAWYK5THdFi1qWEEvjYTbAQ9fceHYBO/PEIBP7q2p2YfMP4L8qnouaeTkP8052aGiK6X1rUbZVc9ljhZ5EqJlKr7EyKvVcFTAXBbxKKOVamg7OwL7KPSz0poQ381WhS4iq+k2sTOxUvm5W6o8xW2sLLdVWFkeiUrsGAFEDcBD5pZWdal1c/sN8uy7uoaCpi8PaoKLI7L+xygq1fKtNFanM17IU9aa01c51mXWVbalbrTLQm7pSmYRNMdf6lzG10DoDVcu8QmdVsGMVdp4p4Yh+Hj7955WZveYAYJijMGwx5w5566ygZuhDcgicDaLJ5PblfpykTWccoL+nOUwbCmVuZHN0cmVhbQplbmRvYmoKNCAwIG9iago8PC9Db250ZW50cyA1IDAgUi9NZWRpYUJveFswIDAgNTk1IDg0Ml0vUGFyZW50IDIgMCBSL1Jlc291cmNlczw8L0ZvbnQ8PC9GMSA2IDAgUi9GMTAgMTUgMCBSL0YxMSAxNiAwIFIvRjEyIDE3IDAgUi9GMTMgMTggMCBSL0YxNCAxOSAwIFIvRjE1IDIwIDAgUi9GMTYgMjEgMCBSL0YyIDcgMCBSL0YzIDggMCBSL0Y0IDkgMCBSL0Y1IDEwIDAgUi9GNiAxMSAwIFIvRjcgMTIgMCBSL0Y4IDEzIDAgUi9GOSAxNCAwIFI+Pj4+L1RyaW1Cb3hbMCAwIDU5NSA4NDJdL1R5cGUvUGFnZT4+CmVuZG9iagoxIDAgb2JqCjw8L1BhZ2VzIDIgMCBSL1R5cGUvQ2F0YWxvZz4+CmVuZG9iagozIDAgb2JqCjw8L0NyZWF0aW9uRGF0ZShEOjIwMjIwMzAzMTA1ODU1KzA1JzMwJykvTW9kRGF0ZShEOjIwMjIwMzAzMTA1ODU1KzA1JzMwJykvUHJvZHVjZXIoaVRleHSuIDcuMC40IKkyMDAwLTIwMTcgaVRleHQgR3JvdXAgTlYgXChBR1BMLXZlcnNpb25cKSk+PgplbmRvYmoKMjEgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjIwIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxOSAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTggMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE3IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxNiAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTUgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjE0IDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxMyAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKMTIgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjExIDAgb2JqCjw8L0Jhc2VGb250L1RpbWVzLVJvbWFuL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZy9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udD4+CmVuZG9iagoxMCAwIG9iago8PC9CYXNlRm9udC9UaW1lcy1Sb21hbi9FbmNvZGluZy9XaW5BbnNpRW5jb2RpbmcvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQ+PgplbmRvYmoKOSAwIG9iago8PC9CYXNlRm9udC9Db3VyaWVyLUJvbGQvRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjggMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjcgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjYgMCBvYmoKPDwvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nL1N1YnR5cGUvVHlwZTEvVHlwZS9Gb250Pj4KZW5kb2JqCjIgMCBvYmoKPDwvQ291bnQgMS9LaWRzWzQgMCBSXS9UeXBlL1BhZ2VzPj4KZW5kb2JqCnhyZWYKMCAyMgowMDAwMDAwMDAwIDY1NTM1IGYgCjAwMDAwMDA5OTggMDAwMDAgbiAKMDAwMDAwMjY1MyAwMDAwMCBuIAowMDAwMDAxMDQzIDAwMDAwIG4gCjAwMDAwMDA3MTEgMDAwMDAgbiAKMDAwMDAwMDAxNSAwMDAwMCBuIAowMDAwMDAyNTYzIDAwMDAwIG4gCjAwMDAwMDI0NzMgMDAwMDAgbiAKMDAwMDAwMjM4MyAwMDAwMCBuIAowMDAwMDAyMjkyIDAwMDAwIG4gCjAwMDAwMDIyMDEgMDAwMDAgbiAKMDAwMDAwMjExMCAwMDAwMCBuIAowMDAwMDAyMDE5IDAwMDAwIG4gCjAwMDAwMDE5MjggMDAwMDAgbiAKMDAwMDAwMTgzNyAwMDAwMCBuIAowMDAwMDAxNzQ2IDAwMDAwIG4gCjAwMDAwMDE2NTUgMDAwMDAgbiAKMDAwMDAwMTU2NCAwMDAwMCBuIAowMDAwMDAxNDczIDAwMDAwIG4gCjAwMDAwMDEzODIgMDAwMDAgbiAKMDAwMDAwMTI5MSAwMDAwMCBuIAowMDAwMDAxMjAwIDAwMDAwIG4gCnRyYWlsZXIKPDwvSUQgWzxmMDI1YWY0NzQ5MjBkZjBmOGFlZTRhMmE4MTM2ZTc5OT48ZjAyNWFmNDc0OTIwZGYwZjhhZWU0YTJhODEzNmU3OTk+XS9JbmZvIDMgMCBSL1Jvb3QgMSAwIFIvU2l6ZSAyMj4+CiVpVGV4dC03LjAuNApzdGFydHhyZWYKMjcwNAolJUVPRgo=\"\n    }\n  } ]\n}";

		KeyMaterialDTO receiverKeyMaterial = dataRequestDTO.getHiRequest().getKeyMaterial();
		KeyMaterial senderKeyMaterial = keysGenerator.generate();
		EncryptionRequest encryptionRequest = new EncryptionRequest(receiverKeyMaterial.getDhPublicKey().getKeyValue(),
				receiverKeyMaterial.getNonce(), senderKeyMaterial.getPrivateKey(), senderKeyMaterial.getPublicKey(),
				senderKeyMaterial.getNonce(), fhirNewDate2);

		EncryptionResponse encryptionResponse = encryption.encrypt(encryptionRequest);

		EntryDTO entryDTO = EntryDTO.builder().content(encryptionResponse.getEncryptedData())
				.media("application/fhir+json").checksum("").careContextReference("LINK_REF_67788").build();

		/*
		 * logger.info("ReceiverKeyMaterialDTO {}", receiverKeyMaterial);
		 * logger.info("SenderKeyMaterialDTO {}", senderKeyMaterial);
		 * logger.info("KeyToShare {}", encryptionResponse.getKeyToShare());
		 */

		KeyMaterialDTO keyMaterialDTO = KeyMaterialDTO.builder().cryptoAlg(receiverKeyMaterial.getCryptoAlg())
				.curve(receiverKeyMaterial.getCurve())
				.dhPublicKey(DhPublicKeyDTO.builder().expiry("2022-04-30T12:00:50.810Z")
						.parameters(receiverKeyMaterial.getDhPublicKey().getParameters())
						.keyValue(encryptionResponse.getKeyToShare()).build())
				.nonce(senderKeyMaterial.getNonce()).build();

		logger.info("dataTransferDummy ends");
		/*
		 * logger.info("dataRequestDTO.getTransactionId() {}",
		 * dataRequestDTO.getTransactionId());
		 */
		return DataTransferDTO.builder().pageCount(1).pageNumber(1).transactionId(dataRequestDTO.getTransactionId())
				.entries(Arrays.asList(entryDTO)).keyMaterial(keyMaterialDTO).build();
	}

	NotifyRequestDTO prepareNotify(DataRequestDTO dataRequestDTO, String sendStatus) {

		logger.info("Sms Notify method starts : {}", dataRequestDTO);

		SimpleDateFormat format1 = new SimpleDateFormat(DATE_FORMAT, Locale.US);
		format1.setTimeZone(TimeZone.getTimeZone("UTC"));

		ArrayList<NotifyStatusResponsDTO> statusResponses = new ArrayList<>();
		CareContextConsentEntity careContextConsentEntity = careContextConsentRepository
				.getByConcentId(dataRequestDTO.getHiRequest().getConsent().getId());

		Set<CareContextsEntity> careContexts = careContextConsentEntity.getCareContexts();
		NotifyStatusNotificationDTO status = null;
		if (sendStatus.contentEquals("SUCCESS")) {
			for (CareContextsEntity context : careContexts) {
				statusResponses.add(NotifyStatusResponsDTO.builder().hiStatus("DELIVERED")
						.careContextReference(context.getCareContextReference()).description("DELIVERED").build());
			}
			status = NotifyStatusNotificationDTO.builder().sessionStatus("TRANSFERRED").hipId("NASHIPDEV")
					.statusResponses(statusResponses).build();
		} else {
			for (CareContextsEntity context : careContexts) {
				statusResponses.add(NotifyStatusResponsDTO.builder().hiStatus("ERRORED")
						.careContextReference(context.getCareContextReference()).description("ERRORED").build());
			}
			status = NotifyStatusNotificationDTO.builder().sessionStatus("FAILED").hipId("NASHIPDEV")
					.statusResponses(statusResponses).build();
		}

		NotifyNotificationDTO notifyNotificationDTO = NotifyNotificationDTO.builder()
				.consentId(dataRequestDTO.getHiRequest().getConsent().getId()).doneAt(format1.format(new Date()))
				.transactionId(dataRequestDTO.getTransactionId())
				.notifier(NotifyNotifierDTO.builder().id(careContextConsentEntity.getPatientId()).type("HIU").build())
				.statusNotification(status).build();
		notifyNotificationDTO.setNotifier(NotifyNotifierDTO.builder().build());
		return NotifyRequestDTO.builder().requestId(UUID.randomUUID().toString()).notification(notifyNotificationDTO)
				.timestamp(format1.format(new Date())).build();
	}

	public ResponseEntity<String> callNotify(DataRequestDTO dataRequestDTO, String sendStatus) {

		String url = transferNotify;
		ResponseEntity<String> result = null;
		URI uri;
		try {
			uri = new URI(url);
			String encryptedString = new Gson().toJson(prepareNotify(dataRequestDTO, sendStatus));
			logger.info("Sent data in sms notify ", encryptedString);
			HttpEntity<String> requestEntity = new HttpEntity<>(encryptedString,
					commonHeadersUtil.getHeadersWithXCmIdFromServer());
			result = restTemplate.exchange(uri, HttpMethod.POST, requestEntity, String.class);
		} catch (Exception e1) {
			logger.info("Error in callNotify  {} ", e1);
			result = new ResponseEntity<>(HttpStatus.EXPECTATION_FAILED);
		}
		return result;
	}

	// dummy implementation of notify method
	NotifyRequestDTO prepareNotifyDummy(DataRequestDTO dataRequestDTO) {
		NotifyNotificationDTO notifyNotificationDTO = NotifyNotificationDTO.builder().build();
		notifyNotificationDTO.setNotifier(NotifyNotifierDTO.builder().build());
		return NotifyRequestDTO.builder().requestId(UUID.randomUUID().toString()).notification(notifyNotificationDTO)

				.build();
	}

	ResponseEntity<String> callNotifyDummy(DataRequestDTO dataRequestDTO) {
		String url = transferNotify;
		ResponseEntity<String> result = null;
		URI uri;
		try {
			uri = new URI(url);
			String encryptedString = new Gson().toJson(prepareNotifyDummy(dataRequestDTO));
			HttpEntity<String> requestEntity = new HttpEntity<>(encryptedString,
					commonHeadersUtil.getHeadersWithXCmIdFromServer());
			result = restTemplate.exchange(uri, HttpMethod.POST, requestEntity, String.class);
		} catch (Exception e1) {
			logger.info("Error in on-discover health id missing  {} ", e1);
			result = new ResponseEntity<>(HttpStatus.EXPECTATION_FAILED);
		}
		return result;
	}

}
